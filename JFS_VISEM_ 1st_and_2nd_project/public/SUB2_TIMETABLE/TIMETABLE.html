<!DOCTYPE html>
<html>
<head>
    <title>Timetable Viewer</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
        }

        table {
            width: 90%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
            vertical-align: top;
        }

        th {
            background-color: lightblue;
        }

        .batch-title, .faculty-title {
            font-size: 20px;
            font-weight: bold;
            margin-top: 30px;
        }

        select {
            padding: 6px;
            font-size: 14px;
            margin: 10px 0 20px 0;
        }

        .highlight-batch {
            color: red;
            padding: 4px;
            display: block;
        }
    </style>
</head>

<body>

<h2>Upload Timetable CSV</h2>
<input type="file" id="csvFile" accept=".csv">

<br><br>

<label><b>Select Faculty:</b></label><br>
<select id="facultySelect">
    <option value="">-- Select Faculty --</option>
</select>

<div id="tables"></div>

<script>
let csvData = [];

/* ================= Load CSV ================= */
document.getElementById("csvFile").addEventListener("change", function () {
    Papa.parse(this.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: function (result) {
            csvData = result.data;
            populateFacultyDropdown(csvData);
        }
    });
});

/* ================= Dropdown ================= */
function populateFacultyDropdown(data) {
    const select = document.getElementById("facultySelect");
    select.innerHTML = '<option value="">-- Select Faculty --</option>';

    // ALL option
    const allOpt = document.createElement("option");
    allOpt.value = "ALL";
    allOpt.textContent = "ALL FACULTY (Show All Timetables)";
    select.appendChild(allOpt);

    const faculties = [...new Set(
        data.map(r => r.FACULTY).filter(Boolean)
    )];

    faculties.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = f;
        select.appendChild(opt);
    });

    select.onchange = () => handleSelection(select.value);
}

/* ================= Handle Selection ================= */
function handleSelection(value) {
    const container = document.getElementById("tables");
    container.innerHTML = "";

    if (!value) return;

    if (value === "ALL") {
        buildAllBatchTimetables(csvData);
    } else {
        buildFacultyTimetable(value);
    }
}

/* ================= ALL → Batch-wise ================= */
function buildAllBatchTimetables(data) {
    const timetable = {};
    const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];

    data.forEach(r => {
        if (!r.BATCH || !r.DAY || !r.SESSION) return;

        if (!timetable[r.BATCH]) timetable[r.BATCH] = {};
        if (!timetable[r.BATCH][r.DAY])
            timetable[r.BATCH][r.DAY] = { FN: "", AN: "" };

        timetable[r.BATCH][r.DAY][r.SESSION] =
            `<b>${r.COURSE}</b><br>
             Room: ${r.ROOM}<br>
             Faculty: ${r.FACULTY}`;
    });

    const container = document.getElementById("tables");

    for (const batch in timetable) {
        const title = document.createElement("div");
        title.className = "batch-title";
        title.textContent = `Batch: ${batch}`;

        const table = document.createElement("table");

        let html = `
            <tr>
                <th>DAY</th>
                <th>FN</th>
                <th rowspan="7">L<br>U<br>N<br>C<br>H</th>
                <th>AN</th>
            </tr>
        `;

        days.forEach(d => {
            html += `
                <tr>
                    <td>${d}</td>
                    <td>${timetable[batch][d]?.FN || ""}</td>
                    <td>${timetable[batch][d]?.AN || ""}</td>
                </tr>
            `;
        });

        table.innerHTML = html;
        container.appendChild(title);
        container.appendChild(table);
    }
}

/* ================= Faculty → ONE merged ================= */
function buildFacultyTimetable(facultyId) {
    const container = document.getElementById("tables");

    const rows = csvData.filter(r =>
        r.FACULTY &&
        r.FACULTY.trim().toUpperCase() === facultyId.trim().toUpperCase()
    );

    const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];
    const timetable = {};
    days.forEach(d => timetable[d] = { FN: [], AN: [] });

    rows.forEach(r => {
        const highlight = r.BATCH === "VI-SU-B2";
        timetable[r.DAY][r.SESSION].push(
            `<div class="${highlight ? 'highlight-batch' : ''}">
                <b>${r.COURSE}</b><br>
                Batch: ${r.BATCH}<br>
                Room: ${r.ROOM}
             </div>`
        );
    });

    const title = document.createElement("div");
    title.className = "faculty-title";
    title.textContent = `Faculty Timetable: ${facultyId}`;
    container.appendChild(title);

    const table = document.createElement("table");

    let html = `
        <tr>
            <th>DAY</th>
            <th>FN</th>
            <th rowspan="7">L<br>U<br>N<br>C<br>H</th>
            <th>AN</th>
        </tr>
    `;

    days.forEach(d => {
        html += `
            <tr>
                <td>${d}</td>
                <td>${timetable[d].FN.join("<hr>")}</td>
                <td>${timetable[d].AN.join("<hr>")}</td>
            </tr>
        `;
    });

    table.innerHTML = html;
    container.appendChild(table);
}
</script>

</body>
</html>
